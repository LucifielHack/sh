i=47500
url_unique=`cat /root/var.txt`
for var in `cat /root/var.txt`
do
#81 8443 8080 8000 8880
echo "http://${var}" >> /root/var1231.txt
echo "http://${var}:81" >> /root/var1231.txt
echo "http://${var}:8443" >> /root/var1231.txt
echo "http://${var}:8080" >> /root/var1231.txt
echo "http://${var}:8000" >> /root/var1231.txt
echo "http://${var}:8880" >> /root/var1231.txt

echo "https://${var}" >> /root/var1231.txt
echo "https://${var}:81" >> /root/var1231.txt
echo "https://${var}:8443" >> /root/var1231.txt
echo "https://${var}:8080" >> /root/var1231.txt
echo "https://${var}:8000" >> /root/var1231.txt
echo "https://${var}:8880" >> /root/var1231.txt
done

vl /root/var1231.txt | grep -v "\[50" | grep -oP "http.*" >> /root/var123.txt ; rm /root/var1231.txt
sort -u /root/var123.txt -o /root/var123.txt

#whatsweb
webanalyze -update
for line in `cat /root/var123.txt`
do
echo "webanalyze -crawl 12 -host $line -output csv >> /root/whatsweb.txt ; sort -u /root/whatsweb.txt -o /root/whatsweb.txt ; wc -l /root/whatsweb.txt" > analyze.sh ; timeout 36 bash analyze.sh ; rm analyze.sh
done
rm /root/var123.txt








while true
do

comm=`cat /root/var.txt`
if [ "$url_unique" != "$comm" ]
then

for var in `cat /root/var.txt`
do
#81 8443 8080 8000 8880
echo "http://${var}" >> /root/var1231.txt
echo "http://${var}:81" >> /root/var1231.txt
echo "http://${var}:8443" >> /root/var1231.txt
echo "http://${var}:8080" >> /root/var1231.txt
echo "http://${var}:8000" >> /root/var1231.txt
echo "http://${var}:8880" >> /root/var1231.txt

echo "https://${var}" >> /root/var1231.txt
echo "https://${var}:81" >> /root/var1231.txt
echo "https://${var}:8443" >> /root/var1231.txt
echo "https://${var}:8080" >> /root/var1231.txt
echo "https://${var}:8000" >> /root/var1231.txt
echo "https://${var}:8880" >> /root/var1231.txt
done

vl /root/var1231.txt | grep -v "\[50" | grep -oP "http.*" >> /root/var123.txt ; rm /root/var1231.txt
sort -u /root/var123.txt -o /root/var123.txt
#whatsweb
webanalyze -update
for line in `cat /root/var123.txt`
do
echo "webanalyze -crawl 12 -host $line -output csv >> /root/whatsweb.txt ; sort -u /root/whatsweb.txt -o /root/whatsweb.txt ; wc -l /root/whatsweb.txt" > analyze.sh ; timeout 36 bash analyze.sh ; rm analyze.sh
done
rm /root/var123.txt
url_unique=$comm

fi







#确认存在
a=`curl --speed-time 5 --speed-limit 1  https://www.exploit-db.com/download/${i} | grep "Exploit\ Database\ 404"`

if [ "$a" = "" ]
then


#确认类型
curl --speed-time 5 --speed-limit 1  https://www.exploit-db.com/exploits/${i} > curl.txt
web=`cat curl.txt | grep -oP "type=webapps"`

if [ "$web" = "type=webapps" ]
then

#提取指纹
grep -oP "http.*" whatsweb.txt | awk -F, '{print $(NF-1)}' > service.txt ; sort -u service.txt -o service.txt
num=`cat service.txt | wc -l`

#匹配
for((wordnum=1;wordnum<=${num};wordnum+=1))
do
word=`head -$wordnum service.txt | tail -1`
grep2=`cat curl.txt | grep -oP "(?<=title\>).*?(?=\<\/title)" | grep -i "$word"`
#存在则执行
if [ "$grep2" != "" ]
then
grep -i $word whatsweb.txt | awk -F, '{print $1}' > i.txt
toomuch=`cat i.txt | wc -l`
if [ $toomuch -eq 1 ]
then
echo 'go'
for url in `cat i.txt`
do
echo $url >> target.txt
add=,
url=$url$add
grep $url whatsweb.txt | awk -F, '{print $(NF-1)}' >> to.txt
num=`cat to.txt | wc -l`
for((numto=1;numto<=$num;numto+=1))
do
add=`head -$numto to.txt | tail -1`
up=+
add=$up$add
echo $add >> target.txt
done
rm to.txt
echo '' >> target.txt

target=`cat target.txt`
echo "s=hooks.sl ; c=ack.com/ser ; k=vices/TM26L9 ; sck=\$s\$c\$k ; curl -X POST -H \"Content-type:application/json\" --data '{\"text\":\"${word}\n${grep2}\n${target}\nhttps://www.exploit-db.com/exploits/${i}\n\n\"}' https://\${sck}ZEE/BM78UTLGH/GBt3k5B25BqAyc5EDzYPDdhg" > slack.sh
bash slack.sh ; rm slack.sh
rm target.txt
sleep 1
done
rm i.txt
else

mkdir /root/cve
for url in `cat i.txt`
do
name=`echo $grep2 | sed "s, ,_,g"`
echo $url >> /root/cve/${name}.txt
add=,
url=$url$add
grep $url whatsweb.txt | awk -F, '{print $(NF-1)}' >> to.txt
num=`cat to.txt | wc -l`
for((numto=1;numto<=$num;numto+=1))
do
add=`head -$numto to.txt | tail -1`
up=+
add=$up$add
echo $add >> /root/cve/${name}.txt
done
rm to.txt
echo '' >> /root/cve/${name}.txt
done
rm i.txt
accu=`echo $grep2 | grep -oP ".*\ .\." |awk 'NF{NF-=1};1'`
grep -n "\+${accu}" /root/cve/${name}.txt | grep -oP ".*?(?=:)" > accu_loca.txt
for location in `cat accu_loca.txt`
do
up=`head -$location /root/cve/${name}.txt | tail -1`
for((i=1;i<=20;i+=1)); do a=`grep -B $i "$up" /root/cve/${name}.txt | grep "://"`; if [ "$a" != "" ]; then grep -B $i "$up" /root/cve/${name}.txt >> result.txt ; echo ' ' >> result.txt; break; fi; done
done
rm accu_loca.txt
result=`cat result.txt`
echo "s=hooks.sl ; c=ack.com/ser ; k=vices/TM26L9 ; sck=\$s\$c\$k ; curl -X POST -H \"Content-type:application/json\" --data '{\"text\":\"${word}\n${grep2}\n${result}\nhttps://www.exploit-db.com/exploits/${i}\n\n\"}' https://\${sck}ZEE/BM78UTLGH/GBt3k5B25BqAyc5EDzYPDdhg" > slack.sh
bash slack.sh ; rm slack.sh
rm result.txt
fi
fi
done
rm curl.txt
rm service.txt

fi
i=$((i+1))
echo $i
sleep 6
else
sleep 6
fi
done
